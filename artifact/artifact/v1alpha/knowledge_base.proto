syntax = "proto3";

package artifact.artifact.v1alpha;

// Core definitions
import "core/mgmt/v1beta/mgmt.proto";
// Google API
import "google/api/field_behavior.proto";
import "google/api/resource.proto";
// Protocol Buffers Well-Known Types
import "google/protobuf/field_mask.proto";
import "google/protobuf/timestamp.proto";

// KnowledgeBase represents a knowledge base.
// Field ordering convention: uid (1), id (2), name (3), display_name (4), description (5)
message KnowledgeBase {
  option (google.api.resource) = {pattern: "namespaces/{namespace}/knowledge-bases/{knowledge_base}"};

  // EmbeddingConfig defines the embedding configuration for a knowledge base
  message EmbeddingConfig {
    // The AI model family used for embeddings (e.g., "gemini", "openai")
    string model_family = 1;
    // The dimensionality of the embedding vectors
    uint32 dimensionality = 2;
  }

  // The knowledge base uid (internal UUID).
  string uid = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The knowledge base id (URL-safe slug derived from display_name with hash suffix).
  string id = 2 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The resource name of the knowledge base.
  // Format: `namespaces/{namespace}/knowledge-bases/{knowledge_base}`.
  string name = 3 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The human-readable display name for UI presentation.
  // If not provided, defaults to the id.
  string display_name = 4 [(google.api.field_behavior) = OPTIONAL];
  // The knowledge base description.
  string description = 5 [(google.api.field_behavior) = OPTIONAL];
  // The creation time of the knowledge base.
  google.protobuf.Timestamp create_time = 6 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The last update time of the knowledge base.
  google.protobuf.Timestamp update_time = 7 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The owner/namespace of the knowledge base.
  string owner_name = 8 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The knowledge base tags.
  repeated string tags = 9 [(google.api.field_behavior) = OPTIONAL];
  // The knowledge base converting pipelines.
  // Deprecated: Conversion is now handled by AI providers.
  repeated string converting_pipelines = 10 [
    deprecated = true,
    (google.api.field_behavior) = OPTIONAL
  ];
  // The knowledge base splitting pipelines.
  // Deprecated: Chunking is now handled internally.
  repeated string splitting_pipelines = 11 [
    deprecated = true,
    (google.api.field_behavior) = OPTIONAL
  ];
  // The knowledge base embedding pipelines.
  // Deprecated: Use embedding_config instead.
  repeated string embedding_pipelines = 12 [
    deprecated = true,
    (google.api.field_behavior) = OPTIONAL
  ];
  // The downstream apps
  repeated string downstream_apps = 13 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The total files in knowledge base.
  uint32 total_files = 14 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The total tokens in knowledge base.
  uint32 total_tokens = 15 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The current used storage in knowledge base.
  uint64 used_storage = 16 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The knowledge base summarizing pipelines.
  // Deprecated: Summarization is now handled by AI providers.
  repeated string summarizing_pipelines = 17 [
    deprecated = true,
    (google.api.field_behavior) = OPTIONAL
  ];
  // The embedding configuration for the knowledge base.
  EmbeddingConfig embedding_config = 18 [(google.api.field_behavior) = OPTIONAL];
  // The ID of the active Milvus collection for this knowledge base.
  // This supports collection versioning for embedding dimension changes.
  string active_collection_id = 19 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Knowledge base owner.
  optional core.mgmt.v1beta.Owner owner = 20 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The UID of the user who created this knowledge base.
  // This field is optional for system-created knowledge bases (e.g., instill-agent)
  // or legacy knowledge bases created before this field was introduced.
  optional string creator_uid = 21 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The user who created this knowledge base.
  // Populated when creator_uid is present.
  optional core.mgmt.v1beta.User creator = 22 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The UID of the owner namespace (User or Organization) of this knowledge base.
  // This is an immutable identifier, unlike owner_name which may change.
  string owner_uid = 23 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The knowledge base type (persistent or ephemeral).
  // Default is PERSISTENT if not specified during creation.
  KnowledgeBaseType type = 24 [(google.api.field_behavior) = OPTIONAL];
  // System ID defines how the knowledge base will be created based on the system's
  // RAG configurations including:
  // - AI model family (e.g., "openai", "gemini")
  // - Embedding vector dimensionality
  // - Chunking method
  // - Other RAG-related settings
  //
  // Available systems: "openai", "gemini", or custom systems defined in the system table.
  // If not specified, defaults to the default system.
  optional string system_id = 25 [(google.api.field_behavior) = OPTIONAL];
  // Previous IDs that redirect to this knowledge base.
  // When display_name changes, a new ID is generated and old IDs are stored as aliases.
  // This enables backward compatibility for bookmarks, links, and LLM hallucination recovery.
  repeated string aliases = 26 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// Knowledge Base Type. e.g. "persistent" or "ephemeral"
enum KnowledgeBaseType {
  // UNSPECIFIED
  KNOWLEDGE_BASE_TYPE_UNSPECIFIED = 0;
  // PERSISTENT
  KNOWLEDGE_BASE_TYPE_PERSISTENT = 1;
  // EPHEMERAL
  KNOWLEDGE_BASE_TYPE_EPHEMERAL = 2;
}

// CreateKnowledgeBaseRequest represents a request to create a knowledge base.
// Follows the same pattern as CreateCollectionRequest.
message CreateKnowledgeBaseRequest {
  // The ID of the namespace where the knowledge base will be created.
  string namespace_id = 1 [(google.api.field_behavior) = REQUIRED];

  // The knowledge base resource to create.
  // Required fields: display_name
  // Optional fields: id (auto-generated from display_name if not provided),
  //                  description, tags, type, system_id
  KnowledgeBase knowledge_base = 2 [(google.api.field_behavior) = REQUIRED];
}

// CreateKnowledgeBaseResponse represents a response for creating a knowledge base.
message CreateKnowledgeBaseResponse {
  // The created knowledge base resource.
  KnowledgeBase knowledge_base = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// GetKnowledgeBaseRequest represents a request to get a knowledge base.
message GetKnowledgeBaseRequest {
  // The ID of the namespace that owns the knowledge base.
  string namespace_id = 1 [(google.api.field_behavior) = REQUIRED];
  // Knowledge base ID - the resource ID of the knowledge base to fetch.
  string knowledge_base_id = 2 [(google.api.field_behavior) = REQUIRED];
}

// GetKnowledgeBaseResponse represents a response for getting a knowledge base.
message GetKnowledgeBaseResponse {
  // The knowledge base resource.
  KnowledgeBase knowledge_base = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// ListKnowledgeBasesRequest represents a request to list knowledge bases.
// Does not include ephemeral knowledge bases.
message ListKnowledgeBasesRequest {
  // The ID of the namespace for which to list the knowledge bases.
  string namespace_id = 1 [(google.api.field_behavior) = REQUIRED];
  // The maximum number of knowledge bases to return. If this parameter is unspecified,
  // at most 10 knowledge bases will be returned. The cap value for this parameter
  // is 100 (i.e. any value above that will be coerced to 100).
  optional int32 page_size = 2 [(google.api.field_behavior) = OPTIONAL];
  // Page token for pagination.
  optional string page_token = 3 [(google.api.field_behavior) = OPTIONAL];
  // Filter can hold an [AIP-160](https://google.aip.dev/160)-compliant filter expression.
  // - `id="<knowledge_base_id>"` or `uid="<uuid>"` - Filter by specific knowledge base ID/UID
  // - `q="<text>"` - Fuzzy search on knowledge base ID and description
  //
  // **Examples**:
  // - Filter by ID: `id="my-knowledge-base"`
  // - Search knowledge bases: `q="my-knowledge-base"`
  optional string filter = 4 [(google.api.field_behavior) = OPTIONAL];
}

// ListKnowledgeBasesResponse represents a response for listing knowledge bases.
message ListKnowledgeBasesResponse {
  // The list of knowledge bases.
  repeated KnowledgeBase knowledge_bases = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Next page token for pagination.
  string next_page_token = 2 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Total number of knowledge bases matching the request.
  int32 total_size = 3 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// UpdateKnowledgeBaseRequest represents a request to update a knowledge base.
message UpdateKnowledgeBaseRequest {
  // The ID of the namespace that owns the knowledge base.
  string namespace_id = 1 [(google.api.field_behavior) = REQUIRED];
  // Knowledge base ID - the resource ID of the knowledge base to update.
  string knowledge_base_id = 2 [(google.api.field_behavior) = REQUIRED];
  // The knowledge base fields that will replace the existing ones.
  KnowledgeBase knowledge_base = 3 [(google.api.field_behavior) = REQUIRED];
  // The update mask specifies the subset of fields that should be modified.
  //
  // For more information about this field, see
  // https://developers.google.com/protocol-buffers/docs/reference/google.protobuf#field-mask.
  google.protobuf.FieldMask update_mask = 4 [(google.api.field_behavior) = REQUIRED];
}

// UpdateKnowledgeBaseResponse represents a response for updating a knowledge base.
message UpdateKnowledgeBaseResponse {
  // The updated knowledge base resource.
  KnowledgeBase knowledge_base = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// DeleteKnowledgeBaseRequest represents a request to delete a knowledge base.
message DeleteKnowledgeBaseRequest {
  // The ID of the namespace that owns the knowledge base.
  string namespace_id = 1 [(google.api.field_behavior) = REQUIRED];
  // Knowledge base ID - the resource ID of the knowledge base to delete.
  string knowledge_base_id = 2 [(google.api.field_behavior) = REQUIRED];
}

// DeleteKnowledgeBaseResponse represents a response for deleting a knowledge base.
message DeleteKnowledgeBaseResponse {
  // The deleted knowledge base resource.
  KnowledgeBase knowledge_base = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// CreateKnowledgeBaseAdminRequest represents a request to create a system-level
// knowledge base without a creator (admin only).
message CreateKnowledgeBaseAdminRequest {
  // The ID of the namespace where the knowledge base will be created.
  string namespace_id = 1 [(google.api.field_behavior) = REQUIRED];

  // The knowledge base resource to create.
  // Required fields: id (for admin, id is required rather than auto-generated)
  // Optional fields: display_name (defaults to id), description, tags, type
  KnowledgeBase knowledge_base = 2 [(google.api.field_behavior) = REQUIRED];
}

// CreateKnowledgeBaseAdminResponse represents a response for creating a system-level
// knowledge base.
message CreateKnowledgeBaseAdminResponse {
  // The created knowledge base resource.
  KnowledgeBase knowledge_base = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// UpdateKnowledgeBaseAdminRequest represents a request to update a knowledge base
// with system-reserved tags (admin only).
message UpdateKnowledgeBaseAdminRequest {
  // The ID of the namespace that owns the knowledge base.
  string namespace_id = 1 [(google.api.field_behavior) = REQUIRED];
  // Knowledge base ID - the resource ID of the knowledge base to update.
  string knowledge_base_id = 2 [(google.api.field_behavior) = REQUIRED];
  // The knowledge base fields that will replace the existing ones.
  KnowledgeBase knowledge_base = 3 [(google.api.field_behavior) = REQUIRED];
  // The update mask specifies the subset of fields that should be modified.
  google.protobuf.FieldMask update_mask = 4 [(google.api.field_behavior) = REQUIRED];
}

// UpdateKnowledgeBaseAdminResponse represents a response for updating a knowledge base.
message UpdateKnowledgeBaseAdminResponse {
  // The updated knowledge base resource.
  KnowledgeBase knowledge_base = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}
