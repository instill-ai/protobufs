syntax = "proto3";

package artifact.artifact.v1alpha;

// Core definitions
import "core/mgmt/v1beta/mgmt.proto";
// Google API
import "google/api/field_behavior.proto";
import "google/api/resource.proto";
// Protocol Buffers Well-Known Types
import "google/protobuf/field_mask.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/timestamp.proto";

// file embedding process status
enum FileProcessStatus {
  // UNSPECIFIED
  FILE_PROCESS_STATUS_UNSPECIFIED = 0;
  // NOTSTARTED
  FILE_PROCESS_STATUS_NOTSTARTED = 1;
  // file is being processed (parallel architecture: conversion + summarization)
  FILE_PROCESS_STATUS_PROCESSING = 2;
  // file is chunking
  FILE_PROCESS_STATUS_CHUNKING = 3;
  // file is embedding
  FILE_PROCESS_STATUS_EMBEDDING = 4;
  // completed
  FILE_PROCESS_STATUS_COMPLETED = 5;
  // failed
  FILE_PROCESS_STATUS_FAILED = 6;
}

// converted file type
enum ConvertedFileType {
  // unspecified
  CONVERTED_FILE_TYPE_UNSPECIFIED = 0;
  // content
  CONVERTED_FILE_TYPE_CONTENT = 1;
  // summary
  CONVERTED_FILE_TYPE_SUMMARY = 2;
  // document (standardized to PDF)
  CONVERTED_FILE_TYPE_DOCUMENT = 3;
  // image (standardized to PNG)
  CONVERTED_FILE_TYPE_IMAGE = 4;
  // audio (standardized to OGG)
  CONVERTED_FILE_TYPE_AUDIO = 5;
  // video (standardized to MP4)
  CONVERTED_FILE_TYPE_VIDEO = 6;
}

// File represents a file in a knowledge base.
message File {
  option (google.api.resource) = {pattern: "namespaces/{namespace}/knowledge-bases/{knowledge_base}/files/{file}"};

  // View defines how a file is presented.
  enum View {
    // Unspecified, equivalent to BASIC.
    VIEW_UNSPECIFIED = 0;
    // Default view, only includes basic metadata.
    VIEW_BASIC = 1;
    // Full representation with all metadata.
    VIEW_FULL = 2;
    // Returns MinIO pre-signed URL to converted summary content.
    VIEW_SUMMARY = 3;
    // Returns MinIO pre-signed URL to converted markdown content.
    VIEW_CONTENT = 4;
    // Returns MinIO pre-signed URL to standardized file:
    // - Documents → PDF
    // - Images → PNG
    // - Audio → OGG
    // - Video → MP4
    VIEW_STANDARD_FILE_TYPE = 5;
    // Returns MinIO pre-signed URL to the original uploaded file.
    VIEW_ORIGINAL_FILE_TYPE = 6;
    // Returns Gemini cache resource name.
    VIEW_CACHE = 7;
  }

  // Storage provider for file resources
  enum StorageProvider {
    // Unspecified, defaults to MinIO for backward compatibility
    STORAGE_PROVIDER_UNSPECIFIED = 0;
    // Use MinIO as the storage backend (default)
    STORAGE_PROVIDER_MINIO = 1;
    // Use Google Cloud Storage as the storage backend
    STORAGE_PROVIDER_GCS = 2;
  }

  // Supported file types
  enum Type {
    // unspecified
    TYPE_UNSPECIFIED = 0;

    // Text-based document types
    // text
    TYPE_TEXT = 1;
    // MARKDOWN
    TYPE_MARKDOWN = 2;
    // HTML
    TYPE_HTML = 3;
    // CSV
    TYPE_CSV = 4;

    // Container-based document types
    // PDF
    TYPE_PDF = 5;
    // DOC
    TYPE_DOC = 6;
    // DOCX
    TYPE_DOCX = 7;
    // PPT
    TYPE_PPT = 8;
    // PPTX
    TYPE_PPTX = 9;
    // XLS
    TYPE_XLS = 10;
    // XLSX
    TYPE_XLSX = 11;

    // Image types
    // PNG
    TYPE_PNG = 12;
    // JPEG
    TYPE_JPEG = 13;
    // GIF
    TYPE_GIF = 14;
    // WEBP
    TYPE_WEBP = 15;
    // TIFF
    TYPE_TIFF = 16;
    // BMP
    TYPE_BMP = 17;
    // HEIC
    TYPE_HEIC = 18;
    // HEIF
    TYPE_HEIF = 19;
    // AVIF
    TYPE_AVIF = 20;

    // Audio types
    // MP3
    TYPE_MP3 = 21;
    // WAV
    TYPE_WAV = 22;
    // AAC
    TYPE_AAC = 23;
    // OGG
    TYPE_OGG = 24;
    // FLAC
    TYPE_FLAC = 25;
    // M4A
    TYPE_M4A = 26;
    // WMA
    TYPE_WMA = 27;
    // AIFF
    TYPE_AIFF = 28;
    // WEBM (audio)
    TYPE_WEBM_AUDIO = 29;

    // Video types
    // MP4
    TYPE_MP4 = 30;
    // AVI
    TYPE_AVI = 31;
    // MOV
    TYPE_MOV = 32;
    // MKV
    TYPE_MKV = 33;
    // FLV
    TYPE_FLV = 34;
    // WMV
    TYPE_WMV = 35;
    // MPEG
    TYPE_MPEG = 36;
    // WEBM (video)
    TYPE_WEBM_VIDEO = 37;
  }

  // FileMediaType describes the media category of a knowledge base file.
  enum FileMediaType {
    // Unspecified.
    FILE_MEDIA_TYPE_UNSPECIFIED = 0;
    // Document.
    FILE_MEDIA_TYPE_DOCUMENT = 1;
    // Image.
    FILE_MEDIA_TYPE_IMAGE = 2;
    // Audio.
    FILE_MEDIA_TYPE_AUDIO = 3;
    // Video.
    FILE_MEDIA_TYPE_VIDEO = 4;
  }

  // Position within a file, as coordinates in a a specific unit. The
  // number of dimensions of the coordinate depends on the unit type.
  message Position {
    // Unit of measurement for a position within a file.
    enum Unit {
      // Unspecified.
      UNIT_UNSPECIFIED = 0;
      // Character positions (for Markdown and other text files).
      UNIT_CHARACTER = 1;
      // Page positions (for documents). For pages, positions are 1-indexed
      // (e.g., page 4 of 4) to align with document visualization standards.
      UNIT_PAGE = 2;
      // Time positions in milliseconds (for audio/video files).
      UNIT_TIME_MS = 3;
      // Pixel positions (for images and other 2D content).
      UNIT_PIXEL = 4;
    }

    // Unit of measurement for the position.
    Unit unit = 1 [(google.api.field_behavior) = OUTPUT_ONLY];

    // Position value.
    repeated uint32 coordinates = 2 [(google.api.field_behavior) = OUTPUT_ONLY];
  }

  // Field ordering convention: uid (1), id (2), name (3), display_name (4), description (5)

  // The file uid (internal UUID).
  string uid = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The file id (URL-safe slug derived from display_name with hash suffix).
  string id = 2 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The resource name of the file.
  // Format: `namespaces/{namespace}/knowledge-bases/{knowledge_base}/files/{file}`.
  string name = 3 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The human-readable display name (filename) provided by the user.
  // This is typically the original filename of the uploaded file.
  string display_name = 4 [(google.api.field_behavior) = OPTIONAL];
  // A description of the file.
  string description = 5 [(google.api.field_behavior) = OPTIONAL];
  // File type.
  Type type = 6 [(google.api.field_behavior) = OPTIONAL];
  // File process status.
  FileProcessStatus process_status = 7 [(google.api.field_behavior) = OUTPUT_ONLY];
  // File process outcome message.
  string process_outcome = 8 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Retrievable flag (reserved for future use).
  bool retrievable = 9 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Base64-encoded file content (reserved for future use).
  string content = 10 [(google.api.field_behavior) = OPTIONAL];
  // The UID of the owner namespace (User or Organization) of this file.
  // This is an immutable identifier, unlike owner_name which may change.
  string owner_uid = 11 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The UID of the user who created this file.
  string creator_uid = 12 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The user who created this file.
  // Populated when creator_uid is present.
  optional core.mgmt.v1beta.User creator = 27 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Resource name of the owner namespace.
  string owner_name = 28 [(google.api.field_behavior) = OUTPUT_ONLY];
  // File owner (User or Organization).
  optional core.mgmt.v1beta.Owner owner = 29 [
    (google.api.field_behavior) = OPTIONAL,
    (google.api.field_behavior) = OUTPUT_ONLY
  ];
  // The ID of the knowledge base this file belongs to.
  string knowledge_base_id = 13 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The timestamp when the file was created.
  google.protobuf.Timestamp create_time = 14 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The timestamp when the file was last updated.
  google.protobuf.Timestamp update_time = 15 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The timestamp when the file was deleted (soft delete).
  google.protobuf.Timestamp delete_time = 16 [(google.api.field_behavior) = OUTPUT_ONLY];
  // File size in bytes.
  int64 size = 17 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Total number of chunks created from this file.
  int32 total_chunks = 18 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Total number of tokens in this file.
  int32 total_tokens = 19 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Custom metadata provided by the user during file upload.
  optional google.protobuf.Struct external_metadata = 20 [(google.api.field_behavior) = OPTIONAL];
  // Object UID referencing a file already uploaded to blob storage.
  // Two upload approaches are supported:
  // 1. Direct upload: Upload file directly to MinIO via GetObjectUploadURL, then provide the object_uid here.
  //    This avoids base64 encoding overhead and is preferred for large files.
  // 2. Inline content: Provide base64-encoded file content in the 'content' field (field 9).
  //    The system will handle the blob storage upload internally.
  // When object_uid is provided, the 'content' field is ignored.
  string object_uid = 21 [(google.api.field_behavior) = OPTIONAL];
  // summary field (removed - use GetFile with VIEW_SUMMARY instead)
  reserved 22;
  // Pre-signed download URL for the file.
  string download_url = 23 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Pipeline used for converting the file to Markdown if the file is a
  // document (i.e., a file with pdf, doc[x] or ppt[x] extension). The value
  // identifies the pipeline release and and MUST have the format
  // `{namespaceID}/{pipelineID}@{version}`.
  // The pipeline recipe MUST have the following variable and output fields:
  // ```yaml variable
  // variable:
  //   document_input:
  //     title: document-input
  //     description: Upload a document (PDF/DOCX/DOC/PPTX/PPT)
  //     type: file
  // ```
  // The `convert_result` output should be a list of strings, one per page.
  // ```yaml output
  // output:
  //  convert_result:
  //    title: convert-result
  //    value: ${merge-markdown-refinement.output.results[0]}
  // ```
  // Other variable and output fields will be ignored.
  //
  // The pipeline will be executed first, falling back to the knowledge base's
  // conversion pipelines if the conversion doesn't yield a non-empty result
  // (see the knowledge base creation endpoint documentation).
  //
  // For non-document knowledge base files, the conversion pipeline is deterministic
  // (such files are typically trivial to convert and don't require a dedicated
  // pipeline to improve the conversion performance).
  optional string converting_pipeline = 24 [(google.api.field_behavior) = OPTIONAL];
  // Length of the file in the specified unit type. It is defined as the number
  // of positions (the unit will depend on the file type) that can be accessed
  // in the file.
  Position length = 25 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Array of tags associated with the file.
  repeated string tags = 26 [(google.api.field_behavior) = OPTIONAL];
  // Collection UIDs that this file belongs to.
  // This field is system-managed and populated from collection membership.
  repeated string collection_uids = 30 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Previous IDs that redirect to this file.
  // When display_name changes, a new ID is generated and old IDs are stored as aliases.
  // This enables backward compatibility for bookmarks, links, and LLM hallucination recovery.
  repeated string aliases = 31 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// CreateFileRequest represents a request to create a file.
message CreateFileRequest {
  // The namespace ID.
  string namespace_id = 1 [(google.api.field_behavior) = REQUIRED];
  // knowledge base id
  string knowledge_base_id = 2 [(google.api.field_behavior) = REQUIRED];
  // file
  File file = 3 [(google.api.field_behavior) = OPTIONAL];
}

// CreateFileResponse represents a response for creating a file.
message CreateFileResponse {
  // file
  File file = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// DeleteFileRequest represents a request to delete a file.
message DeleteFileRequest {
  // The namespace id.
  string namespace_id = 1 [(google.api.field_behavior) = REQUIRED];
  // The knowledge base id.
  string knowledge_base_id = 2 [(google.api.field_behavior) = REQUIRED];
  // The file id.
  string file_id = 3 [(google.api.field_behavior) = REQUIRED];
}

// DeleteFileResponse represents a response for deleting a file.
message DeleteFileResponse {
  // The file id.
  string file_id = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// Admin-only file operations

// DeleteFileAdminRequest represents a request to delete a file (admin only).
message DeleteFileAdminRequest {
  // The file id.
  string file_id = 1 [(google.api.field_behavior) = REQUIRED];
}

// DeleteFileAdminResponse represents a response for deleting a file (admin only).
message DeleteFileAdminResponse {
  // The file id.
  string file_id = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// ListFilesRequest represents a request to list files.
message ListFilesRequest {
  // The namespace ID.
  string namespace_id = 1 [(google.api.field_behavior) = REQUIRED];
  // The knowledge base id.
  string knowledge_base_id = 2 [(google.api.field_behavior) = REQUIRED];
  // The page size (default:10; max 100).
  optional int32 page_size = 3 [(google.api.field_behavior) = OPTIONAL];
  // The next page token(default from first file's token).
  optional string page_token = 4 [(google.api.field_behavior) = OPTIONAL];
  // Filter can hold an [AIP-160](https://google.aip.dev/160)-compliant filter expression.
  // - `id="<uuid>"` or `uid="<uuid>"` - Filter by specific file ID/UID (supports multiple IDs separated by OR)
  // - `process_status="FILE_PROCESS_STATUS_COMPLETED"` - Filter by processing status
  //
  // **Examples**:
  // - List specific files: `id="uuid1" OR id="uuid2"`
  // - List completed files: `process_status="FILE_PROCESS_STATUS_COMPLETED"`
  optional string filter = 5 [(google.api.field_behavior) = OPTIONAL];
}

// ListFilesResponse represents a response for listing files.
message ListFilesResponse {
  // The list of files.
  repeated File files = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The total number of files.
  int32 total_size = 2 [(google.api.field_behavior) = OUTPUT_ONLY];
  // The requested page size.
  int32 page_size = 3 [(google.api.field_behavior) = OUTPUT_ONLY];
  // next page token
  string next_page_token = 4 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// GetFileRequest represents a request to get a file.
message GetFileRequest {
  // The namespace id.
  string namespace_id = 1 [(google.api.field_behavior) = REQUIRED];
  // The knowledge base id.
  string knowledge_base_id = 2 [(google.api.field_behavior) = REQUIRED];
  // The file id.
  string file_id = 3 [(google.api.field_behavior) = REQUIRED];
  // View allows clients to specify the desired file view in the response.
  optional File.View view = 4 [(google.api.field_behavior) = OPTIONAL];
  // Storage provider specifies which storage backend to use for the file resource.
  // This field is only applicable for views that return file content:
  // VIEW_SUMMARY, VIEW_CONTENT, VIEW_STANDARD_FILE_TYPE, VIEW_ORIGINAL_FILE_TYPE.
  // - STORAGE_PROVIDER_UNSPECIFIED or STORAGE_PROVIDER_MINIO: Returns MinIO pre-signed URL (default)
  // - STORAGE_PROVIDER_GCS: Uploads file to GCS if not present (with cache check), returns GCS signed URL
  // GCS requires proper configuration in system settings.
  optional File.StorageProvider storage_provider = 5 [(google.api.field_behavior) = OPTIONAL];
}

// GetFileResponse represents a response for getting a file.
message GetFileResponse {
  // The file metadata (always included).
  File file = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Derived resource URI based on view and storage provider:
  // - VIEW_SUMMARY/CONTENT/STANDARD_FILE_TYPE/ORIGINAL_FILE_TYPE:
  //   * STORAGE_PROVIDER_MINIO (default): MinIO pre-signed URL
  //   * STORAGE_PROVIDER_GCS: GCS signed URL (file uploaded to GCS if needed)
  // - VIEW_CACHE: Gemini/VertexAI cache resource name (format: cacheContent/<cacheId>)
  // Only populated for views that return file content.
  optional string derived_resource_uri = 2 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// UpdateFileRequest represents a request to update a file.
message UpdateFileRequest {
  // Namespace ID.
  string namespace_id = 1 [(google.api.field_behavior) = REQUIRED];
  // Knowledge Base ID.
  string knowledge_base_id = 2 [(google.api.field_behavior) = REQUIRED];
  // File ID.
  string file_id = 3 [(google.api.field_behavior) = REQUIRED];
  // The file fields that will replace the existing ones.
  File file = 4 [(google.api.field_behavior) = OPTIONAL];
  // The update mask specifies the subset of fields that should be modified.
  //
  // For more information about this field, see
  // https://developers.google.com/protocol-buffers/docs/reference/google.protobuf#field-mask.
  google.protobuf.FieldMask update_mask = 5 [(google.api.field_behavior) = REQUIRED];
}

// UpdateFileResponse represents a response for updating a file.
message UpdateFileResponse {
  // Updated file.
  File file = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// ReprocessFileRequest represents a request to reprocess a file.
message ReprocessFileRequest {
  // The namespace id.
  string namespace_id = 1 [(google.api.field_behavior) = REQUIRED];
  // The knowledge base id.
  string knowledge_base_id = 2 [(google.api.field_behavior) = REQUIRED];
  // The file id to reprocess.
  string file_id = 3 [(google.api.field_behavior) = REQUIRED];
}

// ReprocessFileResponse represents a response for reprocessing a file.
message ReprocessFileResponse {
  // The file being reprocessed.
  File file = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Status message.
  string message = 2 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// UpdateFileAdminRequest represents a request to update a file with system-reserved
// tags (admin only). Used by internal services like agent-backend to set tags
// with reserved prefixes (e.g., "agent:collection:{uid}").
message UpdateFileAdminRequest {
  // The namespace id.
  string namespace_id = 1 [(google.api.field_behavior) = REQUIRED];
  // The knowledge base id.
  string knowledge_base_id = 2 [(google.api.field_behavior) = REQUIRED];
  // The file id.
  string file_id = 3 [(google.api.field_behavior) = REQUIRED];
  // The file fields that will replace the existing ones.
  File file = 4 [(google.api.field_behavior) = OPTIONAL];
  // The update mask specifies the subset of fields that should be modified.
  google.protobuf.FieldMask update_mask = 5 [(google.api.field_behavior) = REQUIRED];
}

// UpdateFileAdminResponse represents a response for updating a file.
message UpdateFileAdminResponse {
  // Updated file.
  File file = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}
