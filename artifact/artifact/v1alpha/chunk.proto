syntax = "proto3";

package artifact.artifact.v1alpha;

import "artifact/artifact/v1alpha/file.proto";
import "common/view/v1beta/view.proto";
// Protocol Buffers Well-Known Types
import "google/api/field_behavior.proto";
import "google/protobuf/timestamp.proto";

// FileMediaType describes the type of a catalog file.
enum FileMediaType {
  // Unspecified.
  FILE_MEDIA_TYPE_UNSPECIFIED = 0;
  // Document.
  FILE_MEDIA_TYPE_DOCUMENT = 1;
  // Image.
  FILE_MEDIA_TYPE_IMAGE = 2;
  // Audio.
  FILE_MEDIA_TYPE_AUDIO = 3;
  // Video.
  FILE_MEDIA_TYPE_VIDEO = 4;
}

// ContentType describes the type of a chunk content.
enum ContentType {
  // Unspecified.
  CONTENT_TYPE_UNSPECIFIED = 0;
  // Chunks represent a part of the original file.
  CONTENT_TYPE_CHUNK = 1;
  // Summary of the original file.
  CONTENT_TYPE_SUMMARY = 2;
  // Original chunk content enhanced with additional information.
  CONTENT_TYPE_AUGMENTED = 3;
}

// Chunk represents a part of the original file, which will be used for
// embedding and, later, retrieval.
message Chunk {
  // Reference represents the position of a chunk within its source file.
  message Reference {
    // Start position of the chunk within the file.
    FilePosition start = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
    // End position of the chunk within the file.
    FilePosition end = 2 [(google.api.field_behavior) = OUTPUT_ONLY];
  }

  // The name and unique identifier of the chunk.
  // - Format: `namespaces/{namespace.id}/catalogs/{catalog.id}/chunks/{chunk.id}`.
  string name = 16 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Chunk resource ID (used in `name` as the last segment). This field is
  // generated by the server.
  // TODO: references to chunk_uid still need to be migrated to chunk.id.
  string id = 15 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Chunk searchability.
  bool retrievable = 2 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Token count for the chunk.
  uint32 tokens = 6 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Chunk creation time.
  google.protobuf.Timestamp create_time = 7 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Resource name of the original file the chunk was extracted from.
  string file = 17 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Content type.
  ContentType content_type = 9 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Reference to the position of the chunk within the original file.
  Reference reference = 10 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Reference to the position of the chunk within the Markdown (source) file.
  Reference markdown_reference = 11 [(google.api.field_behavior) = OUTPUT_ONLY];
  // View defines how the chunk is presented. The following fields are
  // only shown in the FULL view:
  // - content
  // - embedding
  common.view.v1beta.View view = 12 [(google.api.field_behavior) = OUTPUT_ONLY];
  // String representation of the chunk.
  string content = 13 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Vector representation of the chunk.
  repeated float embedding = 14 [(google.api.field_behavior) = OUTPUT_ONLY];

  // Unique identifier of the chunk
  // Deprecated: use id instead.
  string chunk_uid = 1 [
    deprecated = true,
    (google.api.field_behavior) = OUTPUT_ONLY
  ];
  // start position of the chunk in the source file
  // Deprecated: use markdown_reference instead
  uint32 start_pos = 4 [
    deprecated = true,
    (google.api.field_behavior) = OUTPUT_ONLY
  ];
  // end position of the chunk in the source file
  // Deprecated: use markdown_reference instead
  uint32 end_pos = 5 [
    deprecated = true,
    (google.api.field_behavior) = OUTPUT_ONLY
  ];
  // Unique identifier of the original file.
  // Deprecated. Use file instead.
  string original_file_uid = 8 [
    deprecated = true,
    (google.api.field_behavior) = OUTPUT_ONLY
  ];
}

// ListChunksRequest represents a request to list the chunks of a catalog file.
message ListChunksRequest {
  // ID of the catalog owner.
  string namespace_id = 1 [(google.api.field_behavior) = REQUIRED];
  // Catalog ID.
  string catalog_id = 2 [(google.api.field_behavior) = REQUIRED];
  // Unique file identifier.
  string file_uid = 3 [(google.api.field_behavior) = REQUIRED];
  // The maximum number of items to return. The default and cap values are 10
  // and 100, respectively.
  optional int32 page_size = 4 [(google.api.field_behavior) = OPTIONAL];
  // Page token. By default, the first page will be returned.
  optional string page_token = 5 [(google.api.field_behavior) = OPTIONAL];

  // View allows clients to specify the desired view in the response.
  optional common.view.v1beta.View view = 6 [(google.api.field_behavior) = OPTIONAL];

  // Filter can hold an [AIP-160](https://google.aip.dev/160)-compliant filter expression.
  // The following filters are supported:
  // - `contentType`
  //
  // **Examples**:
  // - List chunks with a "chunk" content type: `contentType="CONTENT_TYPE_CHUNK"`.
  optional string filter = 7 [(google.api.field_behavior) = OPTIONAL];
}

// ListChunksResponse contains a paginated list of chunks.
message ListChunksResponse {
  // A list of chunks matching the request parameters.
  repeated Chunk chunks = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Next page token.
  string next_page_token = 2 [(google.api.field_behavior) = OUTPUT_ONLY];
  // Total number of items.
  int32 total_size = 3 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// Search chunks request
message SearchChunksRequest {
  // owner/namespace id (not uid)
  string namespace_id = 1 [(google.api.field_behavior) = REQUIRED];
  // chunk uids
  repeated string chunk_uids = 2 [(google.api.field_behavior) = REQUIRED];
}

// Search chunks response
message SearchChunksResponse {
  // repeated chunks
  repeated Chunk chunks = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// Create chunk response
message UpdateChunkRequest {
  // chunk uid
  string chunk_uid = 1 [(google.api.field_behavior) = REQUIRED];
  // whether the chunk is retrievable
  bool retrievable = 2 [(google.api.field_behavior) = REQUIRED];
}

// update chunk response
message UpdateChunkResponse {
  // chunk
  Chunk chunk = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// Similar chunk search request
message SimilarityChunksSearchRequest {
  // ID of the namespace owning the catalog.
  string namespace_id = 1 [(google.api.field_behavior) = REQUIRED];
  // ID of the catalog.
  string catalog_id = 2 [(google.api.field_behavior) = REQUIRED];
  // Text prompt to look for similarities.
  string text_prompt = 3 [(google.api.field_behavior) = REQUIRED];
  // Top K. Default value: 5.
  uint32 top_k = 4 [(google.api.field_behavior) = OPTIONAL];
  // 5 is reserved for file_name, deprecated by file_uid.
  reserved 5;
  // Content type.
  ContentType content_type = 6 [(google.api.field_behavior) = OPTIONAL];
  // File type.
  FileMediaType file_media_type = 7 [(google.api.field_behavior) = OPTIONAL];
  // 8 is reserved for file_uid, deprecated by file_uids.
  reserved 8;
  // File UIDs. When this field is provided, the response will return only
  // chunks that belong to the specified file UIDs.
  repeated string file_uids = 9 [(google.api.field_behavior) = OPTIONAL];
}

// Similar chunk search response
message SimilarityChunksSearchResponse {
  // chunks
  repeated SimilarityChunk similar_chunks = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// similarity chunks
message SimilarityChunk {
  // chunk uid
  string chunk_uid = 1 [(google.api.field_behavior) = OUTPUT_ONLY];
  // similarity score
  float similarity_score = 2 [(google.api.field_behavior) = OUTPUT_ONLY];
  // content
  string text_content = 3 [(google.api.field_behavior) = OUTPUT_ONLY];
  // source file's name
  string source_file = 4 [(google.api.field_behavior) = OUTPUT_ONLY];
  // chunk
  Chunk chunk_metadata = 5 [(google.api.field_behavior) = OUTPUT_ONLY];
}

// QuestionAnsweringRequest
message QuestionAnsweringRequest {
  // ID of the namespace owning the catalog.
  string namespace_id = 1;
  // ID of the catalog.
  string catalog_id = 2;
  // Text prompt with the question.
  string question = 3;
  // Top K. Default value: 5.
  int32 top_k = 4;
  // File UIDs. When this field is provided, the response will only use the
  // specified files to build the answer. The UIDs must be UUID-formatted
  // strings.
  repeated string file_uids = 9 [(google.api.field_behavior) = OPTIONAL];
}

// QuestionAnsweringResponse
message QuestionAnsweringResponse {
  // answer to the question
  string answer = 1;
  // chunks
  repeated SimilarityChunk similar_chunks = 2;
}
