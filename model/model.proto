syntax = "proto3";
package instill.model;

option go_package = "github.com/instill-ai/protobufs/model";

// Protobuf standard
import "google/protobuf/any.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/field_mask.proto";
import "google/protobuf/timestamp.proto";
// Google api
import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "google/api/resource.proto";

service Model {
  rpc Liveness(google.protobuf.Empty) returns (HealthCheckResponse) {
    option (google.api.http) = {
      get: "/__liveness"
      additional_bindings: [
        {
          get: "/health/pipeline"
        }
      ]
    };
  }

  rpc Readiness(google.protobuf.Empty) returns (HealthCheckResponse){
    option (google.api.http) = {
      get: "/__readiness"
    };
  }

  rpc CreateModel (stream CreateModelRequest) returns (CreateModelsResponse) {
    option (google.api.http) = {
      post: "/models"
      body: "*"
    };
  }

  rpc LoadModel (LoadModelRequest) returns (LoadModelResponse) {
    option (google.api.http) = {
      post: "/models/{name}/load"
      body: "*"
    };
  }

  rpc UnloadModel (UnloadModelRequest) returns (UnloadModelResponse) {
    option (google.api.http) = {
      post: "/models/{name}/unload"
      body: "*"
    };
  }

  // This method handle upload file request
  rpc PredictModelByUpload (stream PredictModelRequest) returns (PredictModelResponse) {}

  // This method handle request with file in body such as url/base64 encode
  rpc PredictModel (PredictModelRequest) returns (PredictModelResponse) {
    option (google.api.http) = {
      post: "/models/{name}/outputs"
      body: "*"
    };
  }

  rpc ListModels (ListModelRequest) returns (ListModelResponse) {
    option (google.api.http) = {
      get: "/models"
    };
  }
}

message LoadModelRequest {
    string name = 1 [(google.api.field_behavior) = REQUIRED];
}

message LoadModelResponse {
    // OPTIONAL - If nontrivial cost is involved in
    // determining the size, return 0 here and
    // do the sizing in the modelSize function
    uint64 sizeInBytes = 1;

    // EXPERIMENTAL - Applies only if limitModelConcurrency = true
    // was returned from runtimeStatus rpc.
    // See RuntimeStatusResponse.limitModelConcurrency for more detail
    uint32 maxConcurrency = 2;
}

message UnloadModelRequest {
    string name = 1 [(google.api.field_behavior) = REQUIRED];
}

message UnloadModelResponse {}

message PredictModelRequest {
    string name      = 1 [(google.api.field_behavior) = REQUIRED];
    int32 version    = 2 [(google.api.field_behavior) = REQUIRED];
    bytes content    = 3 [(google.api.field_behavior) = REQUIRED];
    int32 type       = 4 [(google.api.field_behavior) = REQUIRED];
}
message PredictModelResponse {
    google.protobuf.Any data  = 1 [(google.api.field_behavior) = REQUIRED];
}

message ListModelRequest {}

message ListModelResponse {
    repeated CreateModelResponse models = 1;
}

message CreateModelsResponse {
    repeated CreateModelResponse models = 1;
}

message Timestamp {
  google.protobuf.Timestamp timestamp = 1;
}

message CreateModelRequest {
  string name        = 1 [(google.api.field_behavior) = REQUIRED];
  string description = 2 [(google.api.field_behavior) = OPTIONAL];
  string type        = 3 [(google.api.field_behavior) = REQUIRED];
  string framework   = 4 [(google.api.field_behavior) = REQUIRED];
  bool optimized     = 5 [(google.api.field_behavior) = OPTIONAL];
  string visibility  = 6 [(google.api.field_behavior) = OPTIONAL];
  string filename    = 7 [(google.api.field_behavior) = REQUIRED];
  bytes content      = 8 [(google.api.field_behavior) = REQUIRED];
}

message ModelVersion {
  int32 version        = 1;
  string model_id      = 2;
  string description   = 3;
  Timestamp created_at = 4;
  Timestamp updated_at = 5;
  string status        = 6;
}

message CreateModelResponse {
  string id                      = 1;
  string name                    = 2;
  bool optimized                 = 3;
  string description             = 4;
  string type                    = 5;
  string framework               = 6;
  Timestamp created_at           = 7;
  Timestamp updated_at           = 8;
  string organization            = 9;
  string visibility              = 10;
  repeated ModelVersion versions = 11;
  string icon                    = 12;
  string Author                  = 13;
  double duration                = 14;
}

message ClassificationOutput {
    string category = 1;
    float score     = 2;
}

message ClassificationOutputs {
    repeated ClassificationOutput contents = 1;
}

message Box {
    float top     = 1;
    float left    = 2;
    float width   = 3;
    float height  = 4;
}

message BoundingBoxPrediction {
    string category = 1;
    float score     = 2;
    Box box         = 3;
}

message DetectionOutput {
    repeated BoundingBoxPrediction contents = 1;
}

message DetectionOutputs {
    repeated DetectionOutput contents = 1;
}

message HealthCheckResponse {
    int32 status = 1;
}