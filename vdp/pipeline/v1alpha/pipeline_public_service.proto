syntax = "proto3";

package vdp.pipeline.v1alpha;

// Google API
import "google/api/annotations.proto";
import "google/api/client.proto";

import "vdp/pipeline/v1alpha/healthcheck.proto";
import "vdp/pipeline/v1alpha/pipeline.proto";

// Pipeline service responds to external access
service PipelinePublicService {
  option (google.api.default_host) = "api.instill.tech";

  // Check if the Pipeline service is alive or dead.
  // 
  // `Liveness` is a call with the method(s) `GET within the `PipelinePublicService` service.
  //
  // This method returns the liveness (alive or dead) of the pipeilne service. 
  //
  // It takes in `LivenessRequest` and returns a `LivenessResponse`.
  //
  // → See [Kubernetes best practices](https://cloud.google.com/blog/products/containers-kubernetes/kubernetes-best-practices-setting-up-health-checks-with-readiness-and-liveness-probes) and [GRPC Health Checking](https://github.com/grpc/grpc/blob/master/doc/health-checking.md) for further details.
  rpc Liveness(LivenessRequest) returns (LivenessResponse) {
    option (google.api.http) = {
      get : "/v1alpha/__liveness"
      additional_bindings : [ {get : "/v1alpha/health/pipeline"} ]
    };
  }

  // Check if the Pipeline service is ready to serve traffics
  //
  // `Readiness` is a call with the method(s) `GET` within the `PipelinePublicService` service.
  //
  // This method returns the Readiness (ready or not ready) of the pipeilne service.
  //
  //  It takes in `ReadinessRequest` and returns a `ReadinessResponse`.
  // 
  // → See [Kubernetes best practices](https://cloud.google.com/blog/products/containers-kubernetes/kubernetes-best-practices-setting-up-health-checks-with-readiness-and-liveness-probes) and [GRPC Health Checking](https://github.com/grpc/grpc/blob/master/doc/health-checking.md) for further details.
  rpc Readiness(ReadinessRequest) returns (ReadinessResponse) {
    option (google.api.http) = {
      get : "/v1alpha/__readiness"
      additional_bindings : [ {get : "/v1alpha/ready/pipeline"} ]
    };
  }

  // Create a new pipeline.
  // 
  // `CreatePipeline` is a call with the method(s) `POST` within the `PipelinePublicService` service. 
  //
  // This method creates a new pipelines (given a recipie consisting of *source*, *model instance* and *destination*). 
  //
  // It takes in `CreatePipelineRequest` and returns `CreatePipelineResponse`.
  //
  // → See [Core concept](https://www.instill.tech/docs/core-concepts/overview) for an introduction to Pipeline in VDP.
  rpc CreatePipeline(CreatePipelineRequest) returns (CreatePipelineResponse) {
    option (google.api.http) = {
      post : "/v1alpha/pipelines"
      body : "pipeline"
    };
    option (google.api.method_signature) = "pipeline";
  }

  // List all existing pipelines.
  //
  // `ListPipelines` is a call with the method(s) `GET` within the `PipelinePublicService` service.
  //
  // This method returns a list consisiting of all existing pipelines. 
  //
  // It takes in `ListPipelinesRequest` and returns `ListPipelinesResponse`.
  //
  // NOTE: if unspecified, this method returns at most 10 pipelines. The maxumum number of pipelines this method can return is set to 100. 
  rpc ListPipelines(ListPipelinesRequest) returns (ListPipelinesResponse) {
    option (google.api.http) = {
      get : "/v1alpha/pipelines"
    };
  }

  // Get the detail of a pipeline with it's name.
  //
  // `GetPipeline` is a call with the method(s) `GET` within the `PipelinePublicService` service.
  //
  // This method return a pipeline with it's name. 
  //
  // It takes in `GetPipelineRequest` and returns `GetPipelineResponse`.
  //
  // NOTE: `pipeline.name` field in `GetPipelineRequest` must have the format of `pipelines/{pipeline_name}`. For example: `pipelines/pipeline-1`.
  rpc GetPipeline(GetPipelineRequest) returns (GetPipelineResponse) {
    option (google.api.http) = {
      get : "/v1alpha/{name=pipelines/*}"
    };
    option (google.api.method_signature) = "name";
  }

  // Update a pipeline in VDP.
  //
  // `UpdatePipeline` is a call with the method(s) `PATCH` within the `PipelinePublicService` service.
  //
  // This methods update an existing pipeline and return the updated pipeline resource. 
  //
  // It takes in `UpdatePipelineRequest` and returns `UpdatePipelineResponse`.
  //
  // **NOTE**: The `pipeline.name` field in `UpdatePipelineRequest` is used to identify the pipeline to update. Format: `pipelines/{pipeline_name}`.
  rpc UpdatePipeline(UpdatePipelineRequest) returns (UpdatePipelineResponse) {
    option (google.api.http) = {
      patch : "/v1alpha/{pipeline.name=pipelines/*}"
      body : "pipeline"
    };
    option (google.api.method_signature) = "pipeline,update_mask";
  }

  // Delete a pipeline in VDP.
  //
  // `DeletePipeline`is a call with the method(s) `DELETE` within the `PipelinePublicService` service.
  //
  // This method deletes a pipeline with it's name. 
  //
  // It takes in `DeletePipelineRequest` and returns `DeletePipelineResponse`.
  //
  // **NOTE**: The `pipeline.name` field in `UpdatePipelineRequest` must have the format of `pipelines/{pipeline_name}`. For example: `pipelines/pipeline-1`.
  rpc DeletePipeline(DeletePipelineRequest) returns (DeletePipelineResponse) {
    option (google.api.http) = {
      delete : "/v1alpha/{name=pipelines/*}"
    };
    option (google.api.method_signature) = "name";
  }

  // Get the detail of a pipeline with it's permalink.
  //
  // `LookUpPipeline` is a call with the method(s) `GET` within the `PipelinePublicService` service.
  //
  // This method return a pipeline resource in VDP given a pipeline permalink. 
  //
  // It takes in `LookUpPipelineRequest` and returns `LookUpPipelineResponse`.
  //
  // NOTE: `pipeline.uid` (permalink) in `LookUpPipelineRequest` must have to format of `pipelines/{uid}`, where `{uid}` denotes the unique ID of the pipeline.
  rpc LookUpPipeline(LookUpPipelineRequest) returns (LookUpPipelineResponse) {
    option (google.api.http) = {
      get : "/v1alpha/{permalink=pipelines/*}/lookUp"
    };
    option (google.api.method_signature) = "permalink";
  }

  // Activate a pipeline in VDP.
  // 
  // `ActivatePipeline` is a call with the method(s) `POST` within the `PipelinePublicService` service.
  //
  // This method activates an existing pipeline. The "state" of the pipeline after activating is "ACTIVE". It can be called on Pipelines in the state "INACTIVE"; Pipelines in a different state (including "ACTIVE") returns an error.
  //
  // It takes in `ActivatePipelineRequest` and returns `ActivatePipelineResponse`.
  //
  // See [Core Concepts - Pipeline](https://www.instill.tech/docs/core-concepts/pipeline) for further details.
  rpc ActivatePipeline(ActivatePipelineRequest)
      returns (ActivatePipelineResponse) {
    option (google.api.http) = {
      post : "/v1alpha/{name=pipelines/*}/activate"
      body : "*"
    };
    option (google.api.method_signature) = "name";
  }

  // Deactivate a pipeline in VDP.
  //
  // `DeactivatePipeline` is a call with the method(s) `POST` within the `PipelinePublicService` service. It can be called on Pipelines in the state "ACTIVE"; Pipelines in a different state (including "INACTIVE") returns an error.
  //
  // This method deactivates a pipeline resource in VDP. The "state" of the pipeline after inactivating is "INACTIVE". 
  //
  // It takes in `DeactivatePipelineRequest` and returns `DeactivatePipelineResponse`.
  //
  // See [Core Concepts - Pipeline](https://www.instill.tech/docs/core-concepts/pipeline) for further details.
  rpc DeactivatePipeline(DeactivatePipelineRequest)
      returns (DeactivatePipelineResponse) {
    option (google.api.http) = {
      post : "/v1alpha/{name=pipelines/*}/deactivate"
      body : "*"
    };
    option (google.api.method_signature) = "name";
  }

  // Rename a pipeline in VDP.
  //
  // `RenamePipeline` is a call with the method(s) `POST` within the `PipelinePublicService` service.
  //
  // This method changes the pipeline name and returns the updated pipeline resource. 
  //
  // It takes in `RenamePipelineRequest` and returns `RenamePipelineResponse`.
  //
  // NOTE: `pipeline.name` field in `RenamePipelineRequest` must has the format of `pipelines/{pipeline_name}`. For example, `pipelines/pipeline-1`.
  rpc RenamePipeline(RenamePipelineRequest) returns (RenamePipelineResponse) {
    option (google.api.http) = {
      post : "/v1alpha/{name=pipelines/*}/rename"
      body : "*"
    };
    option (google.api.method_signature) = "name,new_pipeline_id";
  }

  // Trigger a pipeline resource in VDP.
  //
  // `TriggerPipeline` is a call with the method(s) `POST` within the `PipelinePublicService` service.
  //
  // This methods tiggers a pipeline and returns 1) UUID for each input and 2) model inference outputs. 
  //
  // It takes in `TriggerPipelineRequest` and returns a `TriggerPipelineResponse`.
  //
  // NOTE: `pipeline.name` field in `TriggerPipelineRequest` must has the format of `pipelines/{pipeline_name}`. For example, `pipelines/pipeline-1`.
  // 
  // → See [Core concept](https://www.instill.tech/docs/core-concepts/overview) for an introduction to Pipeline in VDP and [our tutorial](https://www.instill.tech/tutorials/vdp-101-4-how-to-trigger-a-sync-pipeline) for further details about triggering a pipeline.
  rpc TriggerPipeline(TriggerPipelineRequest)
      returns (TriggerPipelineResponse) {
    option (google.api.http) = {
      post : "/v1alpha/{name=pipelines/*}/trigger"
      body : "*"
    };
    option (google.api.method_signature) = "name,inputs";
  }

  // Trigger a pipeline resource in VDP with a multipart request.
  // 
  // `TriggerPipelineBinaryFileUpload` is a call with the method(s) `POST` within the `PipelinePublicService` service. This method tiggers a pipeline and returns 1) UUID for each input and 2) model instance inference outputs. It takes in `TriggerPipelineBinaryFileUploadRequest` message and returns a `TriggerPipelineBinaryFileUploadResponse`.
  //
  // **NOTE**: pipeline name must have the format of `pipelines/{pipeline.name}`.
  // Endpoint: `POST /v1alpha/{name=pipelines/*}/trigger-multipart`
  // → See [Core concept](https://www.instill.tech/docs/core-concepts/overview) for an introduction to Pipeline in VDP and [our tutorial](https://www.instill.tech/tutorials/vdp-101-4-how-to-trigger-a-sync-pipeline) for further details about triggering a pipeline.
  rpc TriggerPipelineBinaryFileUpload(
      stream TriggerPipelineBinaryFileUploadRequest)
      returns (TriggerPipelineBinaryFileUploadResponse) {
    option (google.api.method_signature) = "name,file";
  }

  // WatchPipeline method receives a WatchPipelineRequest message
  // and returns a WatchPipelineResponse
  rpc WatchPipeline(WatchPipelineRequest)
      returns (WatchPipelineResponse) {
    option (google.api.http) = {
      get : "/v1alpha/{name=pipelines/*}/watch"
    };
    option (google.api.method_signature) = "name";
  }
}
